<!DOCTYPE html>
<!--
Copyright (c) 2014, tibbitts
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are met:

* Redistributions of source code must retain the above copyright notice, this
  list of conditions and the following disclaimer.
* Redistributions in binary form must reproduce the above copyright notice,
  this list of conditions and the following disclaimer in the documentation
  and/or other materials provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE
LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
POSSIBILITY OF SUCH DAMAGE.
-->

<div class="jumbotron">
    <h2>
        Welcome to the Puyallup Stake Family History Center
    </h2>

    <div id="login-start">
        <p>
            If you have a FamilySearch.org account already, please log in. If you don't
            have an account you can create one now, or ask a staff member for help.
        </p>

        <p>
            <button class='btn btn-lg btn-primary' id='show-login-screen'>Log in to FamilySearch.org</button>

        </p>
    </div>

    <div id="login-wait">
        <h3>
            Please wait while we load your FamilySearch.org account
        </h3>
        <div class="progress">
            <div class="progress-bar progress-bar-striped active"  role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                <span class="sr-only"></span>
            </div>
        </div>
    </div>

    <div id="login-continue">
        <h3>
            Welcome, <span id="user-name">USER NAME</span>
        </h3>

        <p>
            Now you need to set up a PIN you'll use to access your data while you're in the center.
            The PIN should be 4-6 characters and contain only the characters 0-9.
        </p>

        <div class="panel panel-default" style="max-width: 300px;">
            <div class="panel-body">
                <form id="set-pin-form">
                    <div class="panel-heading"><h3>Create PIN</h3></div>
                    <div class="input-group input-group-lg">
                        <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                        <input type="password" id="pin-input" pattern="[0-9]*" class="form-control" placeholder="PIN" maxlength="6" />
                    </div>
                    <br>
                    <div class="input-group input-group-lg">
                        <span class="input-group-addon"><span class="glyphicon glyphicon-th"></span></span>
                        <input type="password" id="pin-confirm" pattern="[0-9]*" class="form-control" placeholder="Confirm PIN" maxlength="6" />
                    </div>
                    <br>
                    <button type="submit" class='btn btn-lg btn-primary' id='set-pin' >Set Pin</button>
                </form>
            </div>
        </div>
    </div>

    <div id="login-success">
        <h3>
            Success!
        </h3>

        <p>
            You are now logged into the center. Choose your name from any controller and enter your PIN to access your
            FamilySearch.org data.
        </p>

        <p>
            This page will now reset to allow another patron to log in...
        </p>
    </div>
</div>

<div id="permissions-modal" class="modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" id="close-permissions-btn"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <img src="/media/FSMosaicTreeLogo.png" style="height: 50px" />
            </div>
            <div class="modal-body">
                <h4>Puyallup Stake Family History Center would like to:</h4>

                <hr>

                <p style="font-size: 16px">
                    <span class="glyphicon glyphicon-user" style="font-size: 20px"></span>
                    Know your basic FamilySearch profile information
                </p>

                <p style="font-size: 16px">
                    <span class="glyphicon glyphicon-cloud-download" style="font-size: 20px"></span>
                    Access data about your ancestors from FamilySearch Family Tree
                </p>

                <p class="small">
                Puyallup Stake Family History Center will use this information in accordance with their respective terms of service and privacy policies.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="accept-permissions-btn">Accept</button>
                <button type="button" class="btn btn-default" data-dismiss="modal" id="cancel-permissions-btn">Cancel</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div>

<script src="js/familysearch-javascript-sdk.min.js"></script>

<script>
    var timeout;
    settings.local = {
        verbs: {
            "app-key": function (obj) {
                FamilySearch.init({
                    app_key: obj.key,
                    environment: obj.environment,
                    auth_callback: 'https://localhost:8443/auth-redirect.html',
                    http_function: $.ajax,
                    deferred_function: $.Deferred,
                    save_access_token: false
                });
                $("#login-start").show();
            }
        }
    };

    $("#login-start").hide();
    $("#login-wait").hide();
    $("#login-continue").hide();
    $("#login-success").hide();
    ws.socketSend("get-app-key");

    $("#show-login-screen").click(function (event) {
        event.preventDefault();

        $("#login-start").hide();
        $("#login-wait").show();

        timeout = setTimeout(function () {
            reset("Timeout logging into FamilySearch. Please try again.");
        }, 60000);

        FamilySearch.getAccessToken().then(function (accessToken) {
            $("#messages").html("");
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                reset("Timeout accepting permissions. Please log in again");
            }, 60000);

            $("#permissions-modal").modal("show");

            $("#cancel-permissions-btn, #close-permissions-btn").click(function() {
                //TODO: Revoke access token
                reset("You must accept the permissions from FamilySearch.org to log into the Puyallup Stake Family History Center");
            });
            $("#accept-permissions-btn").click(function() {
                $("#permissions-modal").modal("hide");
                $("#messages").html("");
                clearTimeout(timeout);
                timeout = setTimeout(function () {
                    reset("Timeout setting PIN. Please log in again");
                }, 60000);

                FamilySearch.getCurrentUser().then(function (result) {
                    var user = result.getUser();
                    var displayName = user.displayName;
                    var userId = user.personId;
//                    var displayName = "Willow Ufgood"; //["Willow Ufgood", "Luke Skywalker", "Indiana Jones"][//Choose random element];
//                    var userId = "AEF-2344";        //TODO
//                    var accessToken = "fake-access-token-replace-with-actual";

                    $("#user-name").html(displayName);

                    $("#login-wait").hide();
                    $("#login-continue").show();

                    $("#set-pin-form").submit(function (event) {
                        $("#messages").html("");
                        event.preventDefault();
                        clearTimeout(timeout);

                        var pin = $("#pin-input").val();
                        var pinConfirm = $("#pin-confirm").val();

                        if (pin !== pinConfirm) {
                            //TODO: Replace this with actual validation
                            logger.error("PINs don't match");
                            timeout = setTimeout(function () {
                                navigate("kiosk-main");
                                warn("Timeout creating PIN. Please log in again.", 5000);
                            }, 60000);
                            return;
                        }


                        settings.page.gotAccessToken(userId, displayName, pin, accessToken);

                        $("#login-continue").hide();
                        $("#login-success").show();
                        setTimeout(function () {
                            reset();
                        }, 10000);
                    });
                });


            });
        });
    });

    function reset(message) {
        $("#permissions-modal").modal("hide");
        if (timeout) clearTimeout(timeout);
        navigate("kiosk-main");
        if (message) {
            logger.warn(message, 5000);
        }
    }
</script>


<div>
    <nav class="navbar navbar-default navbar-fixed-bottom">
        <div class="container-fluid">
            <div class="nav navbar-nav navbar-right">
                <img src="/media/FS-Certified.png" style="height: 40px; margin-right: 20px; " alt="Family Search Certified"/>
            </div>
        </div>
    </nav>
</div>